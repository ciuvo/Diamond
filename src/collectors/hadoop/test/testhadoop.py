#!/usr/bin/python
################################################################################

from test import *

from diamond.collector import Collector
from hadoop import HadoopCollector

import os

################################################################################

class TestHadoopCollector(CollectorTestCase):
    def setUp(self):
        config = get_collector_config('HadoopCollector', {
            'metrics':  [os.path.dirname(__file__)+'/fixtures/*metrics.log'],
        })

        self.collector = HadoopCollector(config, {})

    @patch.object(Collector, 'publish_metric')
    def test_should_work_with_real_data(self, publish_mock):
        self.collector.collect()

        self.assertPublishedMetricMany(publish_mock, {
            'dfs.datanode.replaceBlockOp_num_ops' : 0.000000, 
            'dfs.datanode.replaceBlockOp_avg_time' : 0.000000, 
            'dfs.datanode.blocks_read' : 0.000000, 
            'dfs.datanode.readMetadataOp_avg_time' : 0.000000, 
            'dfs.datanode.copyBlockOp_num_ops' : 0.000000, 
            'dfs.datanode.heartBeats_avg_time' : 1.000000, 
            'dfs.datanode.writes_from_local_client' : 44.000000, 
            'dfs.datanode.blockReports_avg_time' : 0.000000, 
            'dfs.datanode.readBlockOp_num_ops' : 0.000000, 
            'dfs.datanode.writeBlockOp_num_ops' : 44.000000, 
            'dfs.datanode.readMetadataOp_num_ops' : 0.000000, 
            'dfs.datanode.blocks_written' : 44.000000, 
            'dfs.datanode.writeBlockOp_avg_time' : 5.000000, 
            'dfs.datanode.writes_from_remote_client' : 0.000000, 
            'dfs.datanode.copyBlockOp_avg_time' : 0.000000, 
            'dfs.datanode.readBlockOp_avg_time' : 0.000000, 
            'dfs.datanode.reads_from_remote_client' : 0.000000, 
            'dfs.datanode.block_verification_failures' : 0.000000, 
            'dfs.datanode.reads_from_local_client' : 0.000000, 
            'dfs.datanode.blocks_removed' : 0.000000, 
            'dfs.datanode.blockReports_num_ops' : 1.000000, 
            'dfs.datanode.heartBeats_num_ops' : 7.000000, 
            'dfs.datanode.blocks_verified' : 0.000000, 
            'dfs.datanode.bytes_written' : 64223.000000, 
            'dfs.datanode.blocks_replicated' : 0.000000, 
            'dfs.namenode.CreateFileOps' : 44.000000, 
            'dfs.namenode.AddBlockOps' : 44.000000, 
            'dfs.namenode.SafemodeTime' : 102.000000, 
            'dfs.namenode.Syncs_num_ops' : 100.000000, 
            'dfs.namenode.blockReport_num_ops' : 1.000000, 
            'dfs.namenode.GetListingOps' : 1.000000, 
            'dfs.namenode.Syncs_avg_time' : 0.000000, 
            'dfs.namenode.Transactions_avg_time' : 0.000000, 
            'dfs.namenode.DeleteFileOps' : 0.000000, 
            'dfs.namenode.fsImageLoadTime' : 98.000000, 
            'dfs.namenode.blockReport_avg_time' : 0.000000, 
            'dfs.namenode.GetBlockLocations' : 0.000000, 
            'dfs.namenode.Transactions_num_ops' : 148.000000, 
            'dfs.namenode.FilesRenamed' : 0.000000, 
            'dfs.namenode.FilesCreated' : 59.000000, 
            'dfs.FSNamesystem.CapacityRemainingGB' : 78.000000, 
            'dfs.FSNamesystem.FilesTotal' : 60.000000, 
            'dfs.FSNamesystem.CapacityTotalGB' : 201.000000, 
            'dfs.FSNamesystem.PendingReplicationBlocks' : 0.000000, 
            'dfs.FSNamesystem.BlocksTotal' : 44.000000, 
            'dfs.FSNamesystem.UnderReplicatedBlocks' : 44.000000, 
            'dfs.FSNamesystem.ScheduledReplicationBlocks' : 0.000000, 
            'dfs.FSNamesystem.CapacityUsedGB' : 0.000000, 
            'dfs.FSNamesystem.TotalLoad' : 1.000000, 
            'jvm.metrics.doorstop_local.DataNode.logWarn' : 0.000000, 
            'jvm.metrics.doorstop_local.DataNode.logError' : 0.000000, 
            'jvm.metrics.doorstop_local.DataNode.threadsRunnable' : 7.000000, 
            'jvm.metrics.doorstop_local.DataNode.threadsWaiting' : 6.000000, 
            'jvm.metrics.doorstop_local.DataNode.memHeapCommittedM' : 7.437500, 
            'jvm.metrics.doorstop_local.DataNode.threadsTimedWaiting' : 8.000000, 
            'jvm.metrics.doorstop_local.DataNode.threadsNew' : 0.000000, 
            'jvm.metrics.doorstop_local.DataNode.memHeapUsedM' : 5.551376, 
            'jvm.metrics.doorstop_local.DataNode.memNonHeapUsedM' : 16.977356, 
            'jvm.metrics.doorstop_local.DataNode.threadsTerminated' : 0.000000, 
            'jvm.metrics.doorstop_local.DataNode.logInfo' : 159.000000, 
            'jvm.metrics.doorstop_local.DataNode.gcCount' : 15.000000, 
            'jvm.metrics.doorstop_local.DataNode.threadsBlocked' : 0.000000, 
            'jvm.metrics.doorstop_local.DataNode.logFatal' : 0.000000, 
            'jvm.metrics.doorstop_local.DataNode.memNonHeapCommittedM' : 23.187500, 
            'jvm.metrics.doorstop_local.DataNode.gcTimeMillis' : 58.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.logWarn' : 3.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.logError' : 0.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.threadsRunnable' : 5.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.threadsWaiting' : 2.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.memHeapCommittedM' : 7.437500, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.threadsTimedWaiting' : 4.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.threadsNew' : 0.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.memHeapUsedM' : 4.345642, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.memNonHeapUsedM' : 16.325860, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.threadsTerminated' : 0.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.logInfo' : 12.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.gcCount' : 11.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.threadsBlocked' : 0.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.logFatal' : 0.000000, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.memNonHeapCommittedM' : 23.187500, 
            'jvm.metrics.doorstop_local.SecondaryNameNode.gcTimeMillis' : 53.000000, 
            'jvm.metrics.doorstop_local.JobTracker.logWarn' : 0.000000, 
            'jvm.metrics.doorstop_local.JobTracker.logError' : 0.000000, 
            'jvm.metrics.doorstop_local.JobTracker.threadsRunnable' : 6.000000, 
            'jvm.metrics.doorstop_local.JobTracker.threadsWaiting' : 16.000000, 
            'jvm.metrics.doorstop_local.JobTracker.memHeapCommittedM' : 7.437500, 
            'jvm.metrics.doorstop_local.JobTracker.threadsTimedWaiting' : 8.000000, 
            'jvm.metrics.doorstop_local.JobTracker.threadsNew' : 0.000000, 
            'jvm.metrics.doorstop_local.JobTracker.memHeapUsedM' : 4.306557, 
            'jvm.metrics.doorstop_local.JobTracker.memNonHeapUsedM' : 17.360031, 
            'jvm.metrics.doorstop_local.JobTracker.threadsTerminated' : 0.000000, 
            'jvm.metrics.doorstop_local.JobTracker.logInfo' : 27.000000, 
            'jvm.metrics.doorstop_local.JobTracker.gcCount' : 13.000000, 
            'jvm.metrics.doorstop_local.JobTracker.threadsBlocked' : 0.000000, 
            'jvm.metrics.doorstop_local.JobTracker.logFatal' : 0.000000, 
            'jvm.metrics.doorstop_local.JobTracker.memNonHeapCommittedM' : 23.187500, 
            'jvm.metrics.doorstop_local.JobTracker.gcTimeMillis' : 54.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.logWarn' : 0.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.logError' : 0.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.threadsRunnable' : 5.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.threadsWaiting' : 7.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.memHeapCommittedM' : 7.437500, 
            'jvm.metrics.doorstop_local.TaskTracker.threadsTimedWaiting' : 5.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.threadsNew' : 0.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.memHeapUsedM' : 3.176979, 
            'jvm.metrics.doorstop_local.TaskTracker.memNonHeapUsedM' : 13.792732, 
            'jvm.metrics.doorstop_local.TaskTracker.threadsTerminated' : 0.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.logInfo' : 18.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.gcCount' : 11.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.threadsBlocked' : 0.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.logFatal' : 0.000000, 
            'jvm.metrics.doorstop_local.TaskTracker.memNonHeapCommittedM' : 23.187500, 
            'jvm.metrics.doorstop_local.TaskTracker.gcTimeMillis' : 37.000000, 
            'jvm.metrics.doorstop_local.NameNode.logWarn' : 0.000000, 
            'jvm.metrics.doorstop_local.NameNode.logError' : 0.000000, 
            'jvm.metrics.doorstop_local.NameNode.threadsRunnable' : 6.000000, 
            'jvm.metrics.doorstop_local.NameNode.threadsWaiting' : 14.000000, 
            'jvm.metrics.doorstop_local.NameNode.memHeapCommittedM' : 7.437500, 
            'jvm.metrics.doorstop_local.NameNode.threadsTimedWaiting' : 10.000000, 
            'jvm.metrics.doorstop_local.NameNode.threadsNew' : 0.000000, 
            'jvm.metrics.doorstop_local.NameNode.memHeapUsedM' : 5.778725, 
            'jvm.metrics.doorstop_local.NameNode.memNonHeapUsedM' : 17.679695, 
            'jvm.metrics.doorstop_local.NameNode.threadsTerminated' : 0.000000, 
            'jvm.metrics.doorstop_local.NameNode.logInfo' : 133.000000, 
            'jvm.metrics.doorstop_local.NameNode.gcCount' : 16.000000, 
            'jvm.metrics.doorstop_local.NameNode.threadsBlocked' : 0.000000, 
            'jvm.metrics.doorstop_local.NameNode.logFatal' : 0.000000, 
            'jvm.metrics.doorstop_local.NameNode.memNonHeapCommittedM' : 23.187500, 
            'jvm.metrics.doorstop_local.NameNode.gcTimeMillis' : 56.000000, 
            'mapred.shuffleInput.shuffle_fetchers_busy_percent' : 0.000000, 
            'mapred.shuffleInput.shuffle_input_bytes' : 190.000000, 
            'mapred.shuffleInput.shuffle_success_fetches' : 5.000000, 
            'mapred.shuffleInput.shuffle_failed_fetches' : 0.000000, 
            'mapred.job.doorstop_local.Job_Counters.Launched_map_tasks.value' : 10.000000, 
            'mapred.job.doorstop_local.Map-Reduce_Framework.Combine_output_records.value' : 0.000000, 
            'mapred.job.doorstop_local.Map-Reduce_Framework.Map_input_records.value' : 10.000000, 
            'mapred.job.doorstop_local.Job_Counters.Data-local_map_tasks.value' : 10.000000, 
            'mapred.job.doorstop_local.File_Systems.Local_bytes_written.value' : 860.000000, 
            'mapred.job.doorstop_local.Map-Reduce_Framework.Combine_input_records.value' : 0.000000, 
            'mapred.job.doorstop_local.Map-Reduce_Framework.Map_output_records.value' : 20.000000, 
            'mapred.job.doorstop_local.Job_Counters.Launched_reduce_tasks.value' : 1.000000, 
            'mapred.job.doorstop_local.Map-Reduce_Framework.Map_input_bytes.value' : 240.000000, 
            'mapred.job.doorstop_local.File_Systems.HDFS_bytes_read.value' : 1180.000000, 
            'mapred.job.doorstop_local.Map-Reduce_Framework.Map_output_bytes.value' : 320.000000, 
            'mapred.jobtracker.jobs_submitted' : 1.000000, 
            'mapred.jobtracker.reduces_completed' : 0.000000, 
            'mapred.jobtracker.maps_completed' : 10.000000, 
            'mapred.jobtracker.reduces_launched' : 1.000000, 
            'mapred.jobtracker.jobs_completed' : 0.000000, 
            'mapred.jobtracker.maps_launched' : 10.000000, 
            'mapred.shuffleOutput.shuffle_handler_busy_percent' : 0.000000, 
            'mapred.shuffleOutput.shuffle_output_bytes' : 342.000000, 
            'mapred.shuffleOutput.shuffle_failed_outputs' : 0.000000, 
            'mapred.shuffleOutput.shuffle_success_outputs' : 9.000000, 
            'mapred.tasktracker.tasks_failed_timeout' : 0.000000, 
            'mapred.tasktracker.reduces_running' : 1.000000, 
            'mapred.tasktracker.tasks_failed_ping' : 0.000000, 
            'mapred.tasktracker.reduceTaskSlots' : 2.000000, 
            'mapred.tasktracker.mapTaskSlots' : 2.000000, 
            'mapred.tasktracker.maps_running' : 0.000000, 
            'mapred.tasktracker.tasks_completed' : 10.000000, 
            'rpc.metrics.doorstop_local.50905.RpcProcessingTime_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50905.RpcProcessingTime_num_ops' : 0.000000, 
            'rpc.metrics.doorstop_local.50905.RpcQueueTime_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50905.RpcQueueTime_num_ops' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.versionRequest_num_ops' : 1.000000, 
            'rpc.metrics.doorstop_local.8020.RpcQueueTime_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.blockReport_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.sendHeartbeat_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.setPermission_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.delete_num_ops' : 1.000000, 
            'rpc.metrics.doorstop_local.8020.delete_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.getProtocolVersion_num_ops' : 4.000000, 
            'rpc.metrics.doorstop_local.8020.blockReport_num_ops' : 1.000000, 
            'rpc.metrics.doorstop_local.8020.RpcProcessingTime_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.mkdirs_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.register_num_ops' : 1.000000, 
            'rpc.metrics.doorstop_local.8020.RpcQueueTime_num_ops' : 28.000000, 
            'rpc.metrics.doorstop_local.8020.mkdirs_num_ops' : 1.000000, 
            'rpc.metrics.doorstop_local.8020.getProtocolVersion_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.RpcProcessingTime_num_ops' : 28.000000, 
            'rpc.metrics.doorstop_local.8020.setPermission_num_ops' : 1.000000, 
            'rpc.metrics.doorstop_local.8020.sendHeartbeat_num_ops' : 18.000000, 
            'rpc.metrics.doorstop_local.8020.versionRequest_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.8020.register_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50020.RpcProcessingTime_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50020.RpcProcessingTime_num_ops' : 0.000000, 
            'rpc.metrics.doorstop_local.50020.RpcQueueTime_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50020.RpcQueueTime_num_ops' : 0.000000, 
            'rpc.metrics.doorstop_local.50030.RpcProcessingTime_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50030.heartbeat_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50030.getProtocolVersion_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50030.RpcProcessingTime_num_ops' : 21.000000, 
            'rpc.metrics.doorstop_local.50030.RpcQueueTime_avg_time' : 0.000000, 
            'rpc.metrics.doorstop_local.50030.getBuildVersion_num_ops' : 1.000000, 
            'rpc.metrics.doorstop_local.50030.heartbeat_num_ops' : 19.000000, 
            'rpc.metrics.doorstop_local.50030.RpcQueueTime_num_ops' : 21.000000, 
            'rpc.metrics.doorstop_local.50030.getProtocolVersion_num_ops' : 1.000000, 
            'rpc.metrics.doorstop_local.50030.getBuildVersion_avg_time' : 0.000000, 
        })

################################################################################
if __name__ == "__main__":
    unittest.main()
